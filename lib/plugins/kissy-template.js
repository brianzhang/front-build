var fu = require('../fileutil');
var fs = require('fs');
var path = require('path');
var async = require('async');
var _ = require('underscore')


function buildTemplate (job, callback) {
    fs.readFile(job.src, 'utf8', function (err, cnt) {
        if (err) {
            return callback(err);
        }
        var obj = JSON.stringify({html: cnt});
        var wrap = ''+
            '/**\n'+
            '  Template Module Generated by KissyPie \n'+
            ' **/\n'+
            'KISSY.add(function(){\n'+
            '    return ' + obj + ';\n' +
            '});\n';
        fs.writeFile(job.target, wrap, 'utf8', callback);
    });
}


/**
 * plugin kissy template for FrontBuild
 * will mixin the imported css
 */
module.exports = function (config) {
    config = _.extend({
        //tpl 正则
        fileReg: /-tpl\.html$/i, 

        // 子目录
        base: '.'
    }, config);

    return function (page, next) {
        var start_time = new Date();

        var reports = {
            name: 'kissy-template',
            files: []
        };

        var srcBase = page.srcDir;

        fu.findInDir(page.srcDir, config.fileReg, function (err, files) {

            if (err) {
                return next(err);
            }
            if (!files.length) {
                reports.used_time = new Date() - start_time;
                return next(null, reports);
            }
            async.forEach(files, function (file, callback) {
                var job = {
                    src: path.resolve(srcBase, file),
                    target: path.resolve(srcBase, file.replace(/\.html$/i, '.js')),
                    file: file
                };
                reports.files.push(file);
                buildTemplate(job, callback);

            }, function(err) {
                if (err) {
                    return next(err);
                }
                reports.used_time = new Date() - start_time;
                next(null, reports);
            });
        });

    }
};
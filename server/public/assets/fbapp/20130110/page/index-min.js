KISSY.add("utils/build-page",function(a,b,c){function d(){var a=this;d.superclass.constructor.apply(a,arguments)}return a.extend(d,c,{build:function(c,e,f){var g=this;if(!c||!c.length){g.fire(d.EV.ERROR,{message:"\u8bf7\u6307\u5b9aPage"});return}if(!a.trim(e)){g.fire(d.EV.ERROR,{message:"\u8bf7\u6307\u5b9a\u65f6\u95f4\u6233"});return}a.isString(c)&&(c=c.split(",")),g.fire(d.EV.BUILD,{pages:c,timestamp:e}),b({url:g.get("url"),data:{timestamp:e,pages:c.join(","),root:g.get("rootDir")},cache:!1,dataType:"json",success:function(a){if(!f){if(a.err){g.fire(d.EV.ERROR,{fromBuild:!0,error:a.err});return}g.fire(d.EV.SUCCESS,{pages:c,timestamp:e}),a.reports&&g.fire(d.EV.REPORT,{reports:a.reports});return}if(a.err){f(a.err);return}f(null,{pages:c,timestamp:e,reports:a.reports})}})}},{EV:{GROUP_BUILD:"group-build",ERROR:"error",REPORT:"report",SUCCESS:"success",BUILD_ERROR:"build-error",BUILD:"build"},ATTRS:{url:{value:"/build-pages"},rootDir:{value:""}}}),d},{requires:["ajax","base"]}),KISSY.add("utils/build-common",function(a,b){var c=b.all;return{init:function(){var b=c("#fb-build-common"),d=b.siblings(".status");b.on("click",function(b){var e=c(b.target);b.preventDefault(),d.html("building..."),analytics.track("Build Common"),a.ajax({url:e.attr("href"),dataType:"json",success:function(a){if(a.err){var b=a.err;d.html("Error:"+b.message);return}d.html("success!"),setTimeout(function(){d.html("")},2e3)}})})}}},{requires:["node"]}),KISSY.add("utils/calendar-init",function(a,b,c,d){var e=b.all;return{init:function(b){function g(a){var b=e(a.target);if(f.get("el").contains(b))return;if(b.attr("data-cal-trigger"))return;if(b.parent(".ks-cal-box"))return;f.hide()}e(b.triggers).attr("data-cal-trigger","1");var f=new d.Popup({width:192});f.render(),f.on("hide",function(){e(document.body).detach("click",g)}).on("show",function(){e(document.body).on("click",g)});var h=new c(f.get("contentEl"));h.on("select",function(b){this.targetInput&&e(this.targetInput).val(a.Date.format(b.date,"yyyymmdd")),f.hide()}),e(b.triggers).on("click",function(b){f.show();var c=e(b.target);f.align(c,["bl","tl"]),h.targetInput=c;var d=c.val();if(d){var g=d.match(/^(\d{2,4})(\d\d)(\d\d)$/),i=a.Date.parse(g.slice(1).join("-"));h.render({date:i,selected:i})}})}}},{requires:["node","calendar","overlay"]}),KISSY.add("utils/app-history",function(a){function c(){var a=localStorage.getItem(b);if(!a)return[];try{var c=a.split(",")}catch(d){return[]}return c}function d(a){return localStorage.setItem(b,a.join(","))}if(!window.localStorage)return null;var b="AppHistory";return{push:function(b){var e=c();e=a.filter(e,function(a){return a!=b}),e.unshift(b),d(e)},get:function(){return c()},rm:function(b){var e=c();return e=a.filter(e,function(a){return a!=b}),d(e),!0}}}),KISSY.add("utils/local-cache",function(a){function b(a){var b=this;b.KEY=a}return a.augment(b,{set:function(a,b){var c=this,d=c.KEY,e=c.getAll();e[a]=b,c.save()},save:function(){var a=this,b=a.KEY,c=a.getAll();localStorage.setItem(b,JSON.stringify(c))},get:function(a){var b=this,c=b.KEY,d=b.getAll();return d[a]},getAll:function(){var a=this,b=a.KEY;if(a._cache)return a._cache;var c=localStorage.getItem(b);return c?a._cache=JSON.parse(c)||{}:a._cache={},a.getAll()}}),b}),KISSY.add("page/mods/group-select",function(a){var b=a.all,c=".j-version-checkbox";a.ready(function(){b("body").delegate("click",".j-select-group",function(d){var e=b(d.target);d.preventDefault();var f=e.attr("title");f?f=f.split(","):f=[],b(c).each(function(b){a.indexOf(b.val(),f)>-1?b.prop("checked",!0):b.prop("checked",!1)}),analytics.track("Select Group")}).delegate("click",".j-version-checkbox",function(a){var d=b(a.target),e=d.val(),f=e.split("/")[0];b(c).each(function(a){var b=a.val();b!==e&&a.val().split("/")[0]===f&&a.prop("checked",!1)}),analytics.track("Select Version")})})}),KISSY.add("utils/analytics",function(a,b){var c=b.all;return{init:function(){c("body").on("click",function(a){var b=c(a.target),d=b.attr("data-track");d&&analytics.track(d)})}}},{requires:["node"]}),KISSY.add("page/index",function(a,b,c,d,e,f,g,h){function j(b){i("#batch-build-timestamp").val(b.get("timestamp"));var c=b.get("pages");c&&i("input.j-version-checkbox").filter(function(b){return a.indexOf(b.value,c)>-1}).prop("checked",!0)}function k(){var a=[];return i("input.j-version-checkbox").each(function(b){b.prop("checked")&&b.val()&&a.push({el:b.parent(".version"),val:b.val()})}),a}function l(a,b,c){function d(e){if(e>=a.length){c();return}b(a[e],e,function(a){if(a){c(a);return}d(e+1)})}d(0)}function m(b,d){var e=new c({rootDir:b.rootDir}),f=i("#batch-build-timestamp"),g=i("#batch-build-status"),h=i("#batch-build");return h.on("click",function(b){b.preventDefault();var c=f.val(),h=k();if(!h.length)return;a.each(h,function(a){a.el.removeClass("st-error").removeClass("st-ok").removeClass("st-building").addClass("st-queued")}),i("#progress .bar").hide().css("width",0),setTimeout(function(){i("#progress .bar").show()},0),i("#progress").addClass("progress-striped").addClass("active").removeClass("progress-success"),startTime=(new Date).getTime(),l(h,function(a,b,d){var f=a.el;f.addClass("st-building"),e.build(a.val,c,function(a,c){f.removeClass("st-building");if(a){f.addClass("st-error"),d(a);return}i("#progress .bar").css("width",(b+1)/h.length*100+"%"),f.addClass("st-ok"),d(null)})},function(c){c&&(g.html(c.message).show(),b.fromBuild&&a.log(c));var d=(new Date).getTime()-startTime;analytics.track("Build Pages",{length:h.length,avTime:d/h.length}),setTimeout(function(){i("#progress").removeClass("active").removeClass("progress-striped").addClass("progress-success"),setTimeout(function(){a.each(h,function(a){a.el.removeClass("st-error").removeClass("st-ok").removeClass("st-building").removeClass("st-queued")})},500),setTimeout(function(){g.hide()},2e3)},800)}),d.set("timestamp",c),d.set("pages",a.map(h,function(a){return a.val}))}),e}function n(b){var c=new g("app-cache:"+b.rootDir);a.ready(function(){e.init({triggers:"input.timestamp-input"}),d.init(),m(b,c),f.push(b.rootDir),j(c),h.init()})}var i=b.all;return{init:n}},{requires:["node","utils/build-page","utils/build-common","utils/calendar-init","utils/app-history","utils/local-cache","./mods/group-select","utils/analytics"]}); 
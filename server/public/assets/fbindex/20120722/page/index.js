/*
combined files : 

utils/app-history
page/template/app-history-tpl
utils/analytics
page/index

*/
KISSY.add('utils/app-history',function (S) {
    if (!window.localStorage) {
        return null;
    }

    var KEY = 'AppHistory';

    function getList() {
        var src = localStorage.getItem(KEY);

        if (!src) {
            return [];
        }
        try {
            var list = src.split(',');
        } catch (e) {
            return [];
        }

        return list;
    }

    function saveList(list) {
        return localStorage.setItem(KEY, list.join(','));
    }

    return {
        push: function (path) {
            var list = getList();

            list = S.filter(list, function (item) {
                return item != path;
            });

            list.unshift(path);
            saveList(list);
        },
        
        get: function () {
            return getList();
        },
        
        rm: function (path) {
            var list = getList();
            list = S.filter(list, function (item) {
                return item != path
            });
            saveList(list);
            return true;
        }
    }
});
/**
  Template Module Generated by KissyPie 
 **/
KISSY.add('page/template/app-history-tpl',function(){
    return {"html":"<h3>历史记录：</h3>\n{{#each his as item index}}\n<div class=\"his-item\">\n    <a class=\"his-title\" href=\"/app?root={{item}}\">{{item}}\t</a>\n    <a data-track=\"Delete History\" class=\"his-delete\" title=\"delete\" data-index=\"{{index}}\" href=\"#\">&times;</a>\n</div>\n{{/each}}\n"};
});

//noinspection JSValidateTypes
KISSY.add('utils/analytics',function (S, Node) {
    var $ = Node.all;
    return {
        init: function () {
            $('body').on('click', function(ev){
                var $et = $(ev.target);
                var trackType = $et.attr('data-track');
                if (trackType) {
                    analytics.track(trackType);
                }
            });
        }
    }

}, {
    requires: ['node']
});
KISSY.add('page/index',function (S, Node, Template, appHistory, app_history_tpl, Analytics) {
    var $ = Node.all;
    if (appHistory) {
        S.ready(function () {
            var his = appHistory.get(),
                $el_his = $('#app-history');

            if (his.length) {
                $el_his.html(Template(app_history_tpl.html).render({
                    his: his
                }));
            }

            $('body').delegate('click', '.his-delete', function (ev) {
                ev.preventDefault();
                var elItem = $(ev.target).parent('.his-item');
                var path = S.trim(elItem.one('.his-title').text());

                if (appHistory.rm(path)) {
                    $(ev.target).parent('.his-item').fadeOut(.2);
                }
            });

            Analytics.init();
        });
    }
}, {
    requires: ['node', 'template', 'utils/app-history', './template/app-history-tpl', 'utils/analytics']
});

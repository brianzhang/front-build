KISSY.add("utils/build-page",function(a,b,c){function d(){var a=this;d.superclass.constructor.apply(a,arguments)}return a.extend(d,c,{build:function(c,e,f){var g=this;if(!c||!c.length){g.fire(d.EV.ERROR,{message:"\u8bf7\u6307\u5b9aPage"});return}if(!a.trim(e)){g.fire(d.EV.ERROR,{message:"\u8bf7\u6307\u5b9a\u65f6\u95f4\u6233"});return}a.isString(c)&&(c=c.split(",")),g.fire(d.EV.BUILD,{pages:c,timestamp:e}),b({url:g.get("url"),data:{timestamp:e,pages:c.join(","),root:g.get("rootDir")},cache:!1,dataType:"json",success:function(a){if(!f){if(a.err){g.fire(d.EV.ERROR,{fromBuild:!0,error:a.err});return}g.fire(d.EV.SUCCESS,{pages:c,timestamp:e}),a.reports&&g.fire(d.EV.REPORT,{reports:a.reports});return}if(a.err){f(a.err);return}f(null,{pages:c,timestamp:e,reports:a.reports})}})}},{EV:{GROUP_BUILD:"group-build",ERROR:"error",REPORT:"report",SUCCESS:"success",BUILD_ERROR:"build-error",BUILD:"build"},ATTRS:{url:{value:"/build-pages"},rootDir:{value:""}}}),d},{requires:["ajax","base"]}),KISSY.add("utils/calendar-init",function(a,b,c,d){var e=b.all;return{init:function(b){function g(a){var b=e(a.target);if(f.get("el").contains(b))return;if(b.attr("data-cal-trigger"))return;if(b.parent(".ks-cal-box"))return;f.hide()}e(b.triggers).attr("data-cal-trigger","1");var f=new d.Popup({width:192});f.render(),f.on("hide",function(){e(document.body).detach("click",g)}).on("show",function(){e(document.body).on("click",g)});var h=new c(f.get("contentEl"));h.on("select",function(b){this.targetInput&&e(this.targetInput).val(a.Date.format(b.date,"yyyymmdd")),f.hide()}),e(b.triggers).on("click",function(b){f.show();var c=e(b.target);f.align(c,["bl","tl"]),h.targetInput=c;var d=c.val();if(d){var g=d.match(/^(\d{2,4})(\d\d)(\d\d)$/),i=a.Date.parse(g.slice(1).join("-"));h.render({date:i,selected:i})}})}}},{requires:["node","calendar","overlay"]}),KISSY.add("utils/local-cache",function(a){function b(a){var b=this;b.KEY=a}return a.augment(b,{set:function(a,b){var c=this,d=c.KEY,e=c.getAll();e[a]=b,c.save()},save:function(){var a=this,b=a.KEY,c=a.getAll();localStorage.setItem(b,JSON.stringify(c))},get:function(a){var b=this,c=b.KEY,d=b.getAll();return d[a]},getAll:function(){var a=this,b=a.KEY;if(a._cache)return a._cache;var c=localStorage.getItem(b);return c?a._cache=JSON.parse(c)||{}:a._cache={},a.getAll()}}),b}),KISSY.add("page/mods/reporter",function(a,b,c,d,e,f,g,h,i,j,k){var l=a.all,m=function(b){var c=this;c.$el=l(b);if(!c.$el||!c.$el.length)throw new Error("container is not found");a.ready(function(){c.init()})};return a.extend(m,a.Base,{init:function(){var a=this;l("body").delegate("click",".report-plugin-item-hd",function(a){var b=l(a.currentTarget).siblings(".report-plugin-item-bd");b&&b.toggle()})},addError:function(a){var b=this,c=m.error_wrap_tpl.render(a);b.appendReportEl(l(c))},addReport:function(b){var c=this,d={};a.each(b,function(a,b){c.renderer[b]&&a&&(d[b]=c.renderer[b].call(c,a))});var e=m.wrap_tpl.render(d);c.appendReportEl(l(e))},appendReportEl:function(a){a.hide();var b=this,c=b.$el.children();c.length>0?a.insertBefore(c[0]):a.appendTo(b.$el),a.slideDown(.2)},pluginRenderer:{csslint:"csslint_tpl","kissy-template":"files_tpl",uglifyjs:"files_tpl",cssmin:"files_tpl",concat:"concat_tpl",lesscss:"files_tpl","css-combo":"css_combo_tpl","module-compiler":"module_compiler_tpl",xtemplate:"files_tpl"},parserPluginReports:function(b){return console.log(b),a.map(b,function(a){switch(a.name){case"csslint":a.count=a.lintReport.length;break;case"concat":case"css-combo":a.count=a.jobs.length;break;case"cssmin":case"uglifyjs":case"kissy-template":case"xtemplate":case"lesscss":case"module-compiler":a.count=a.files.length}return a})},renderer:{fb:function(a){return m.fb_tpl.render(a)},plugins:function(b){var c=this,d=[];return b=c.parserPluginReports(b),a.each(b,function(a){var b=a.name,e=c.pluginRenderer[b]||null;e&&(e=m[e]);var f=e?e.render(a):"";d.push(m.plugin_tpl.render({name:b,report:a,content:f}))}),d.join("")}}},{fb_tpl:b(c.html),plugin_tpl:b(f.html),wrap_tpl:b(d.html),error_wrap_tpl:b(e.html),csslint_tpl:b(g.html),files_tpl:b(h.html),concat_tpl:b(i.html),css_combo_tpl:b(j.html),module_compiler_tpl:b(k.html)}),m},{requires:["template","../template/report-fb-tpl","../template/report-wrap-tpl","../template/report-error-wrap-tpl","../template/report-plugin-tpl","../template/report-csslint-tpl","../template/report-files-tpl","../template/report-concat-tpl","../template/report-css-combo-tpl","../template/report-module-compiler-tpl"]}),KISSY.add("page/template/report-fb-tpl",function(){return{html:'<div class="report-fb">\n    <span class="number">\n        {{build_version}}\n    </span>\n    <b class=\'block\'></b><b class=\'triangle\'></b>\n    <span class="number">\n        {{build_timestamp}}\n    </span>\n    <span class="number used-time">\n        {{build_used_time}}ms\n    </span>\n</div>'}}),KISSY.add("page/template/report-wrap-tpl",function(){return{html:'<div class="report" style=\'display:none\'>\n    <div class="report-hd">{{fb}}</div>\n    <div class="report-bd">{{plugins}}</div>\n</div>'}}),KISSY.add("page/template/report-error-wrap-tpl",function(){return{html:'<div class="alert alert-error">\n    <h3> {{message}} </h3>\n    <h4>error</h4>\n    <pre>{{text}}</pre>\n    <h4>stack</h4>\n    <pre>{{stack}}</pre>\n</div>\n'}}),KISSY.add("page/template/report-plugin-tpl",function(){return{html:"<div class=\"report-plugin-item\">\n    <div class=\"report-plugin-item-hd{{#if content}} report-plugin-hd-has-content{{/if}}\">\n        <h4>{{name}} \n        {{#if typeof report.count === 'number'}}\n        <span class='plugin-bdg'>\n            <span title='Execed' class=\"badge\">{{report.count}}</span>\n        </span>\n        {{/if}}\n        {{#if typeof report.warningCount === 'number' && report.warningCount > 0}}\n        <span class='plugin-bdg'>\n            <span title='Warning' class=\"badge badge-warning\">{{report.warningCount}}</span>\n        </span>\n        {{/if}}\n        {{#if typeof report.errorCount === 'number' && report.errorCount > 0}}\n        <span class='plugin-bdg'>\n            <span title='Error'  class=\"badge badge-important\">{{report.errorCount}}</span>\n        </span>\n        {{/if}}\n        </h4>\n    </div>\n    {{#if content}}\n    <div class='report-plugin-item-bd'>{{content}}</div>\n    {{/if}}\n    <div class=\"report-plugin-item-ft\">\n        <ul>\n            <li class='used-time'><i class='icon-time'></i> {{report.used_time}} ms\n            </li>\n        </ul>\n    </div>\n</div>"}}),KISSY.add("page/template/report-csslint-tpl",function(){return{html:"<div class=\"csslint-list\">\n    {{#if lintReport&&lintReport.length}}\n        {{#each lintReport as item}}\n            <div class='csslint-list-item'>\n                <h4 class='csslint-file'>{{item.file}}</h4>\n                <!-- <p>{{item.fullpath}}</p> -->\n                <pre>{{item.output}}</pre>\n            </div>\n        {{/each}}\n    {{#else}}\n        \u6ca1\u6709CSS\u6587\u4ef6\n    {{/if}}\n</div>\n"}}),KISSY.add("page/template/report-files-tpl",function(){return{html:'<h4>\u5904\u7406\u6587\u4ef6\u5217\u8868:</h4>\n{{#if !files.length}}\n    <div>\n        \u6ca1\u6709\u6587\u4ef6\n    </div>\n{{#else}}\n    <ul class="plugin-file-list">\n        {{#each files as file}}\n            <li>\n                <i class="icon-file"></i> {{file}}\n            </li>\n        {{/each}}\n    </ul>\n{{/if}}\n'}}),KISSY.add("page/template/report-concat-tpl",function(){return{html:'<h4>\u5904\u7406\u6587\u4ef6\u5217\u8868:</h4>\n{{#if !jobs.length}}\n    <div>\n        \u6ca1\u6709\u6587\u4ef6\n    </div>\n{{#else}}\n    <ul >\n        {{#each jobs as job}}\n            <li>\n                <h4><i class="icon-file"></i> {{job.filename}}</h4>\n                <ul class="plugin-file-list">\n                    {{#each job.files as file}}\n                        <li title=\'{{file.path}}\'>{{file.filename}}</li>\n                    {{/each}}\n                </ul>\n            </li>\n        {{/each}}\n    </ul>\n{{/if}}'}}),KISSY.add("page/template/report-css-combo-tpl",function(){return{html:'<h4>\u5904\u7406\u6587\u4ef6\u5217\u8868:</h4>\n{{#if !jobs.length}}\n    <div>\n        \u6ca1\u6709\u6587\u4ef6\n    </div>\n{{#else}}\n    <ul class="plugin-file-list">\n        {{#each jobs as job}}\n            <li>\n                <h5><i class="icon-file"></i> {{job.filename}} </h5>\n                <ul class="plugin-file-list">\n                    {{#each job.imports as file}}\n                        <li>\n                            <i class="icon-bookmark"></i>  \n                            {{file}}\n                        </li>\n                    {{/each}}\n                </ul>\n            </li>\n        {{/each}}\n    </ul>\n{{/if}}\n'}}),KISSY.add("page/template/report-module-compiler-tpl",function(){return{html:"<h4>Module Compiler:</h4>\n{{#if !files.length}}\n    <div>\n        \u6ca1\u6709\u627e\u5230Kissy\u6a21\u5757\n    </div>\n{{#else}}\n    <ul class=\"plugin-file-list\">\n        {{#each files as file}}\n            <li>\n                <h5 class=\"ks-module status-{{file.status}}\">\n                    <strong title='{{file.path}}'>{{file.name}}</strong>\n                    <span>{{file.status}}</span>\n                    {{#if file.status !== 'ok'}}\n                        <span class=\"status\">[{{file.status}}]</span>\n                    {{/if}}\n                </h5>\n                {{#if file.submods.length}}\n                    <ul class=\"submods\">\n                        {{#each file.submods as mod}}\n                        <li class='status-{{mod.status}}'>\n                            <strong title='{{mod.path}}'>{{mod.name}}</strong>\n                            {{#if mod.status !== 'ok'}}\n                            <span class=\"status\">[{{mod.status}}]</span>\n                            {{/if}}\n                        </li>\n                        {{/each}}\n                    </ul>\n                {{#else}}\n                    \n                {{/if}}\n            </li>\n        {{/each}}\n    </ul>\n{{/if}}"}}),KISSY.add("page/mods/timestamp",function(a){var b=a.all;a.ready(function(){b("body").delegate("click",".build-timestamp",function(a){var c=b(a.target),d=b(".timestamp-input"),e=c.clone(!0),f=c.offset(),g=d.offset();e.appendTo("body"),e.css("position","absolute").css("left",f.left).css("top",f.top).show().animate({left:g.left,top:g.top},.2,"easeNone",function(){d.val(c.html()),setTimeout(function(){e.remove()},0)})})})}),KISSY.add("page/mods/analyzer",function(a,b,c){function e(a){var d=this;e.superclass.constructor.apply(d,arguments),d.tpl=new b(c.html)}var d=a.all;return a.extend(e,a.Base,{analyze:function(){var b=this,c=new a.Defer;return a.io({url:"/analyze-page/"+b.get("pageVersion"),data:{root:b.get("rootDir")},dataType:"json",success:function(a){c.resolve({html:b.tpl.render(a)})},error:function(){c.reject("net work error")}}),c.promise}}),e},{requires:["template","../template/page-analyze-tpl"]}),KISSY.add("page/template/page-analyze-tpl",function(){return{html:'<div class="report">\n    <div class="report-hd">\n        \u6a21\u5757\u4f9d\u8d56\u5206\u6790\n    </div>\n    <div class="report-bd">\n        <div class="analyze-report">\n            {{#if modules.length}}\n                <table class=\'table\'>\n                    <thead>\n                    <tr>\n                        <th>\u5165\u53e3\u6a21\u5757</th>\n                        <th>\u5b50\u6a21\u5757</th>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    {{#each modules as mod}}\n                    <tr>\n                        <td><a target=\'hiddenIframe\' href="/openfile?path={{mod.file}}">{{mod.name}}</a></td>\n                        <td>\n                            {{#if mod.mods.length}}\n                            <ul>\n                                {{#each mod.mods as submod}}\n                                {{#if submod.status === \'ok\'}}\n                                <li class="status-ok"><a target=\'hiddenIframe\' href="/openfile?path={{submod.file}}">{{submod.name}}</a></li>\n                                {{#else}}\n\n                                <li class="status-warning">{{submod.name}} <span class="label label-warning">{{submod.status}}</span></li>\n                                {{/if}}\n\n                                {{/each}}\n                            </ul>\n                            {{#else}}\n                            \u6ca1\u6709\u5b50\u6a21\u5757\n                            {{/if}}\n                        </td>\n                    </tr>\n                    {{/each}}\n\n                    </tbody>\n                </table>\n            {{#else}}\n                \u6ca1\u6709\u627e\u5230\u5165\u53e3\u6a21\u5757\n            {{/if}}\n        </div>\n    </div>\n</div>\n'}}),KISSY.add("utils/analytics",function(a,b){var c=b.all;return{init:function(){c("body").on("click",function(a){var b=c(a.target),d=b.attr("data-track");d&&analytics.track(d)})}}},{requires:["node"]}),KISSY.add("page/index",function(a,b,c,d,e,f,g,h){function j(a,b){var c=new g(a);i("#analyze-modules").on("click",function(){c.analyze().then(function(a){b.appendReportEl(i(a.html))}),analytics.track("Analyze Modules")})}function k(c,d,e){var f=new b({rootDir:c.rootDir}),g=i("#fb-build-page"),h=i("#fb-build-timestamp"),j=i("#fb-build-status");return h.val(d.get("timestamp")),g.on("click",function(a){a.preventDefault(),j.html("building..."),f.build(c.pageVersion,h.val()),analytics.track("Build One Page")}),f.on("build",function(a){d.set("timestamp",a.timestamp)}).on("success",function(a){j.html("success!").show(),setTimeout(function(){j.hide()},2e3)}).on("error",function(a){if(a.fromBuild){e.addError(a.error),j.html("\u6253\u5305\u5931\u8d25\uff01 ").show();return}j.html("error: "+a.error.message).show(),analytics.track("Single Page Error",{message:Message})}).on("report",function(b){a.each(b.reports,function(a){e.addReport(a)})}),f}function l(b){a.ready(function(){var a=new d("page-cache:"+b.rootDir+"/"+b.pageVersion),f=new e("#reports");k(b,a,f),j(b,f),c.init({triggers:"input.timestamp-input"}),h.init()})}var i=a.all;return{init:l}},{requires:["utils/build-page","utils/calendar-init","utils/local-cache","./mods/reporter","./mods/timestamp","./mods/analyzer","utils/analytics"]}); 